<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Browser Roblox-Style RPG</title>
<style>
body { margin:0; overflow:hidden; background:#000; font-family:Arial; color:white }
#loginScreen { position:fixed; inset:0; background:#111; display:flex; justify-content:center; align-items:center; z-index:10 }
.box { background:#1e1e1e; padding:25px; border-radius:10px; width:300px; text-align:center }
input,button { width:100%; padding:10px; margin:6px 0; border-radius:5px; border:none }
button { background:#00ff88; font-weight:bold; cursor:pointer }
#hud, #abilities, #inventory, #shop, #skillTree { position:fixed; background:rgba(0,0,0,.4); padding:8px; border-radius:6px; }
#hud { top:10px; left:10px; z-index:5 }
#abilities { bottom:10px; left:10px; z-index:5 }
#inventory { bottom:10px; right:10px; z-index:5; max-height:300px; overflow:auto }
#shop { top:50%; right:10px; z-index:5; display:none; max-height:300px; overflow:auto }
#skillTree { top:50%; left:10px; z-index:5; display:none; max-height:300px; overflow:auto }
button.small { padding:4px; margin:2px; font-size:12px; }
</style>
</head>
<body>

<div id="loginScreen">
  <div class="box">
    <h2>Sign In</h2>
    <input id="user" placeholder="Username">
    <input id="pass" type="password" placeholder="Password">
    <button onclick="handleLogin()">Enter Game</button>
    <p id="msg"></p>
  </div>
</div>

<div id="hud"></div>
<div id="abilities"></div>
<div id="inventory"></div>
<div id="shop"></div>
<div id="skillTree"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>
/* ================= LOGIN ================= */
function handleLogin(){
  const u=user.value.trim(), p=pass.value.trim();
  if(!u||!p) return msg.innerText="Fill all fields";
  const k="account_"+u;
  if(localStorage.getItem(k)){
    if(localStorage.getItem(k)!==p) return msg.innerText="Wrong password";
  } else localStorage.setItem(k,p);
  localStorage.setItem("currentUser",u);
  startGame();
}

/* ================= GLOBAL ================= */
let scene,camera,renderer,player;
let enemies=[],fakePlayers=[],boss,projectiles=[],particles=[];
let keys={},level=1,xp=0,health=100,data;
let inventory=[],skills={dash:false,fireball:false,ult:false};
let coins=0;
const WORLD_LIMIT=45;
let cooldowns={dash:0,fireball:0,ult:0};

/* Sounds */
const audioAttack=new Audio("https://freesound.org/data/previews/341/341695_3248244-lq.mp3");
const audioFireball=new Audio("https://freesound.org/data/previews/250/250622_4486188-lq.mp3");
const audioUltimate=new Audio("https://freesound.org/data/previews/109/109662_945474-lq.mp3");

/* ================= QUESTS & ACHIEVEMENTS ================= */
let quests = [
  {id:1, desc:"Defeat 5 enemies", target:5, progress:0, reward:{xp:20, coins:10}},
  {id:2, desc:"Collect 3 Health Potions", target:3, progress:0, reward:{xp:10, coins:5}}
];
let achievements = [
  {id:1, name:"First Kill", unlocked:false},
  {id:2, name:"50 Enemies Defeated", unlocked:false}
];
let totalKills = 0;

function updateQuests(enemyDefeated=false){
  quests.forEach(q=>{
    if(q.id===1 && enemyDefeated) q.progress++;
    if(q.id===2) {
      let potions = data.inventory.filter(i=>"Health Potion"===i).length;
      q.progress = Math.min(potions, q.target);
    }
    if(q.progress >= q.target && !q.completed){
      q.completed = true;
      xp += q.reward.xp; coins += q.reward.coins;
      alert(`Quest Completed: ${q.desc}\nReward: ${q.reward.xp} XP, ${q.reward.coins} coins`);
    }
  });
}

function checkAchievements(){
  if(totalKills>=1 && !achievements[0].unlocked){
    achievements[0].unlocked = true;
    alert("Achievement Unlocked: First Kill");
  }
  if(totalKills>=50 && !achievements[1].unlocked){
    achievements[1].unlocked = true;
    alert("Achievement Unlocked: 50 Enemies Defeated");
  }
}

/* ================= START GAME ================= */
function startGame(){
  loginScreen.style.display="none";
  const u=localStorage.getItem("currentUser");
  data=JSON.parse(localStorage.getItem("save_"+u))||{x:0,z:0,level:1,xp:0,health:100,coins:0,inventory:[],skills:{dash:false,fireball:false,ult:false}};
  ({level,xp,health,coins,inventory,skills}=data);

  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x87ceeb);

  camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);
  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  document.body.appendChild(renderer.domElement);

  const light=new THREE.DirectionalLight(0xffffff,1);
  light.position.set(10,20,10);
  scene.add(light);

  const ground=new THREE.Mesh(new THREE.BoxGeometry(100,1,100), new THREE.MeshStandardMaterial({color:0x228B22}));
  ground.position.y=-0.5; scene.add(ground);

  // Portal
  const portal=new THREE.Mesh(new THREE.CylinderGeometry(2,2,0.2,16), new THREE.MeshStandardMaterial({color:0x00ffff}));
  portal.position.set(20,0.1,20); portal.isPortal=true; scene.add(portal);

  player=new THREE.Mesh(new THREE.BoxGeometry(1,2,1), new THREE.MeshStandardMaterial({color:0xff4444}));
  player.position.set(data.x,1,data.z); scene.add(player);

  camera.position.set(0,6,10);

  spawnEnemies(); spawnBoss(); spawnFakePlayers();
  setInterval(save,3000);

  giveDailyReward();
  animate();
}

/* ================= INPUT ================= */
addEventListener("keydown",e=>{
  keys[e.key.toLowerCase()]=true;
  if(e.key==="Shift" && skills.dash) dash();
  if(e.key.toLowerCase()==="f" && skills.fireball) fireball();
  if(e.key.toLowerCase()==="q" && skills.ult) ultimate();
  if(e.key.toLowerCase()==="i") toggleInventory();
  if(e.key.toLowerCase()==="p") toggleShop();
  if(e.key.toLowerCase()==="k") toggleSkillTree();
});
addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);
addEventListener("click",basicAttack);

/* ================= INVENTORY/SHOP/SKILL ================= */
function toggleInventory(){ inventory.style.display=inventory.style.display==="none"?"block":"none"; updateInventory(); }
function toggleShop(){ shop.style.display=shop.style.display==="none"?"block":"none"; updateShop(); }
function toggleSkillTree(){ skillTree.style.display=skillTree.style.display==="none"?"block":"none"; updateSkillTree(); }

function updateInventory(){ inventory.innerHTML="Inventory:<br>"+data.inventory.map((i,idx)=>`<button class="small" onclick="useItem(${idx})">${i}</button>`).join(" "); }
function useItem(idx){ const item=data.inventory[idx]; if(item==="Health Potion"){ health=Math.min(100,health+50); data.inventory.splice(idx,1); updateInventory(); } }

function updateShop(){ const items=[{name:"Health Potion",price:20},{name:"Skill: Dash",price:50},{name:"Skill: Fireball",price:50},{name:"Skill: Ultimate",price:100}]; shop.innerHTML="Shop:<br>"+items.map((it,idx)=>`<button class="small" onclick="buyItem('${it.name}',${it.price})">${it.name} (${it.price} coins)</button>`).join("<br>"); }
function buyItem(name,price){ if(coins<price) return alert("Not enough coins"); coins-=price; if(name.includes("Skill")) skills[name.split(": ")[1].toLowerCase()]=true; else data.inventory.push(name); updateInventory(); updateShop(); }
function updateSkillTree(){ skillTree.innerHTML="Skills:<br>"+Object.keys(skills).map(k=>`${k}: ${skills[k]?"Unlocked":"Locked"}`).join("<br>"); }

/* ================= SPAWNS ================= */
function spawnEnemies(){
  enemies.forEach(e=>scene.remove(e)); enemies=[];
  for(let i=0;i<5+level;i++){
    let color=Math.random()*0xffffff;
    let speed=0.008+Math.random()*0.012;
    let hp=20+Math.floor(Math.random()*20);
    let e=new THREE.Mesh(new THREE.BoxGeometry(1,2,1), new THREE.MeshStandardMaterial({color}));
    e.position.set(rand(),1,rand()); e.hp=hp; e.speed=speed;
    enemies.push(e); scene.add(e);
  }
}
function spawnBoss(){ if(boss) scene.remove(boss); boss=new THREE.Mesh(new THREE.BoxGeometry(3,5,3), new THREE.MeshStandardMaterial({color:0x111111})); boss.position.set(0,2,-35); boss.hp=200+level*60; scene.add(boss); }
function spawnFakePlayers(){ fakePlayers.forEach(p=>scene.remove(p)); fakePlayers=[]; for(let i=0;i<3;i++){ let p=new THREE.Mesh(new THREE.BoxGeometry(1,2,1), new THREE.MeshStandardMaterial({color:0xffff00})); p.position.set(rand(),1,rand()); p.dir=Math.random()*Math.PI*2; fakePlayers.push(p); scene.add(p); } }
function rand(){ return Math.random()*30-15; }

/* ================= COMBAT ================= */
function basicAttack(){
  audioAttack.play();
  enemies=enemies.filter(e=>{
    if(player.position.distanceTo(e.position)<3){
      e.hp-=15;
      if(e.hp<=0){
        scene.remove(e);
        xp+=10; coins+=5; totalKills++;
        dropLoot(e.position);
        updateQuests(true);
        checkAchievements();
        return false;
      }
    }
    return true;
  });
}

function dropLoot(pos){
  const lootTypes = ["Health Potion","Coin","XP Boost"];
  if(Math.random()<0.5){
    const item = lootTypes[Math.floor(Math.random()*lootTypes.length)];
    if(item==="Coin"){ coins += 5; alert("You found 5 coins!"); }
    else if(item==="XP Boost"){ xp += 10; alert("You gained 10 XP!"); }
    else data.inventory.push(item);
  }
}

/* ================= ABILITIES ================= */
function dash(){ if(cooldowns.dash>0) return; cooldowns.dash=120; player.position.x+=Math.sin(camera.rotation.y)*5; player.position.z+=Math.cos(camera.rotation.y)*5; spawnParticle(player.position,"dash"); }
function fireball(){ if(cooldowns.fireball>0) return; cooldowns.fireball=180; audioFireball.play(); let b=new THREE.Mesh(new THREE.SphereGeometry(0.3),new THREE.MeshStandardMaterial({color:0xff2200})); b.position.copy(player.position); b.dir=new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion); projectiles.push(b); scene.add(b); spawnParticle(b.position,"fireball"); }
function ultimate(){ if(cooldowns.ult>0) return; cooldowns.ult=600; audioUltimate.play(); spawnParticle(player.position,"ult"); enemies=enemies.filter(e=>{ if(player.position.distanceTo(e.position)<6){ scene.remove(e); xp+=20; coins+=10; return false; } return true; }); }

/* ================= PARTICLES ================= */
function spawnParticle(pos,type){ for(let i=0;i<5;i++){ let p=new THREE.Mesh(new THREE.SphereGeometry(0.1),new THREE.MeshStandardMaterial({color:type==="fireball"?0xff4400:type==="ult"?0xffff00:0x00ffff})); p.position.copy(pos); p.vel=new THREE.Vector3((Math.random()-0.5)*0.5,Math.random()*0.3,(Math.random()-0.5)*0.5); particles.push(p); scene.add(p); } }

/* ================= DAILY REWARD & BUFFS ================= */
function giveDailyReward(){
  const today = new Date().toDateString();
  const lastClaim = localStorage.getItem("dailyReward_"+localStorage.getItem("currentUser"));
  if(lastClaim !== today){
    coins += 20; xp += 10;
    localStorage.setItem("dailyReward_"+localStorage.getItem("currentUser"), today);
    alert("Daily Reward: 20 Coins & 10 XP!");
  }
}

let activeBuffs = [];
function triggerRandomBuff(){
  if(Math.random()<0.05){ activeBuffs.push({type:"doubleXP",duration:600}); alert("Random Event! Double XP for 10 seconds!"); }
}
function updateBuffs(){ activeBuffs.forEach((b,i)=>{ if(b.type==="doubleXP") xp += 0.05; b.duration--; if(b.duration<=0) activeBuffs.splice(i,1); }); }

/* ================= ANIMATE LOOP ================= */
function animate(){
  requestAnimationFrame(animate);

  // Movement
  if(keys.w) player.position.z-=0.15; if(keys.s) player.position.z+=0.15;
  if(keys.a) player.position.x-=0.15; if(keys.d) player.position.x+=0.15;
  player.position.x=Math.max(-WORLD_LIMIT,Math.min(WORLD_LIMIT,player.position.x));
  player.position.z=Math.max(-WORLD_LIMIT,Math.min(WORLD_LIMIT,player.position.z));

  // Enemy movement
  enemies.forEach(e=>{ e.position.lerp(player.position,e.speed); if(e.position.distanceTo(player.position)<1.5) health-=0.15; });
  boss.position.lerp(player.position,0.008); if(boss.position.distanceTo(player.position)<2.5) health-=0.3;

  // Projectiles
  projectiles=projectiles.filter(b=>{ b.position.add(b.dir.multiplyScalar(0.5)); enemies.forEach(e=>{ if(b.position.distanceTo(e.position)<1){ e.hp-=20; } }); if(b.position.length()>80){ scene.remove(b); return false; } return true; });

  // Particles
  particles=particles.filter(p=>{ p.position.add(p.vel); p.vel.multiplyScalar(0.95); if(p.position.y<0){ scene.remove(p); return false; } return true; });

  // Fake players
  fakePlayers.forEach(p=>{ p.dir+=Math.random()*0.1-0.05; p.position.x+=Math.cos(p.dir)*0.05; p.position.z+=Math.sin(p.dir)*0.05; });

  // Cooldowns
  Object.keys(cooldowns).forEach(k=>{ if(cooldowns[k]>0) cooldowns[k]--; });

  if(health<=0){ health=100; player.position.set(0,1,0); }

  // Portals
  scene.children.forEach(o=>{ if(o.isPortal && player.position.distanceTo(o.position)<2){ player.position.set(-20,1,-20); } });

  // Camera follow
  camera.position.x=player.position.x; camera.position.z=player.position.z+10; camera.lookAt(player.position);

  // Buffs
  triggerRandomBuff(); updateBuffs();

  // HUD
  hud.innerHTML=`User: ${localStorage.getItem("currentUser")}<br>Health: ${Math.floor(health)}<br>XP: ${Math.floor(xp)}<br>Level: ${level}<br>Coins: ${coins}`;
  abilities.innerHTML=`Dash (Shift): ${cooldowns.dash<=0?"READY":cooldowns.dash}<br>Fireball (F): ${cooldowns.fireball<=0?"READY":cooldowns.fireball}<br>Ultimate (Q): ${cooldowns.ult<=0?"READY":cooldowns.ult}`;
  updateInventory(); updateShop(); updateSkillTree();

  renderer.render(scene,camera);
}

/* ================= SAVE ================= */
function save(){ const u=localStorage.getItem("currentUser"); localStorage.setItem("save_"+u,JSON.stringify({x:player.position.x,z:player.position.z,level,xp,health,coins,inventory,skills})); }

if(localStorage.getItem("currentUser")) startGame();
</script>
</body>
</html>